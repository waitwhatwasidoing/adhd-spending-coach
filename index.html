<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Impulse Pause Coach</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: white;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
      max-width: 700px;
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(45deg, #fff, #f0f0f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 16px;
      font-weight: 300;
    }
    
    .chat-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      height: 400px;
      overflow-y: auto;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }
    
    .message {
      margin-bottom: 16px;
      padding: 16px 20px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .ai-message {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.3);
      margin-right: 60px;
    }
    
    .user-message {
      background: rgba(33, 150, 243, 0.2);
      border: 1px solid rgba(33, 150, 243, 0.3);
      margin-left: 60px;
      text-align: right;
    }
    
    .loading-message {
      background: rgba(255, 193, 7, 0.2);
      border: 1px solid rgba(255, 193, 7, 0.3);
      margin-right: 60px;
      font-style: italic;
      opacity: 0.8;
    }
    
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    .btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 14px 28px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn.listening {
      background: rgba(76, 175, 80, 0.3);
      border-color: rgba(76, 175, 80, 0.5);
      animation: pulse 2s infinite;
    }
    
    .btn.speaking {
      background: rgba(255, 193, 7, 0.3);
      border-color: rgba(255, 193, 7, 0.5);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.8; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }
    
    .status {
      text-align: center;
      font-size: 14px;
      opacity: 0.8;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      margin-bottom: 15px;
    }
    
    .ai-indicator {
      font-size: 10px;
      opacity: 0.6;
      text-align: right;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üß† AI Pause Coach</h1>
      <p>Your intelligent ADHD-friendly companion</p>
    </div>
    
    <div id="chatContainer" class="chat-container">
      <!-- Messages will appear here -->
    </div>
    
    <div class="controls">
      <button id="micBtn" class="btn" onclick="toggleMicrophone()">
        <span id="micIcon">üé§</span>
        <span id="micText">Start Listening</span>
      </button>
      <button class="btn" onclick="clearChat()">
        üóëÔ∏è Clear
      </button>
    </div>
    
    <div id="status" class="status">
      Ready to listen and help you pause before impulse purchases
    </div>
  </div>

<script>
// =============================================================================
// AI VOICE ASSISTANT WITH REAL BACKEND INTEGRATION
// Connects to Netlify Functions for real AI responses
// =============================================================================

class AIVoiceCoach {
  constructor() {
    this.isListening = false;
    this.isSpeaking = false;
    this.recognition = null;
    this.conversationHistory = JSON.parse(localStorage.getItem('ai_conversation') || '[]');
    this.voices = [];
    this.bestVoice = null;
    
    // Netlify function endpoint
    this.apiEndpoint = '/.netlify/functions/chat';
    
    this.initializeVoices();
    this.initializeApp();
  }

  async initializeApp() {
    this.restoreConversation();
    
    // Welcome message if no previous conversation
    if (this.conversationHistory.length === 0) {
      const welcomeMsg = "Hey! I'm your AI pause friend. I'm here to chat and help you think through spending decisions. How are you doing today?";
      this.addMessage('ai', welcomeMsg, 'AI');
      this.speak(welcomeMsg);
    }
  }

  initializeVoices() {
    if ('speechSynthesis' in window) {
      const loadVoices = () => {
        this.voices = speechSynthesis.getVoices();
        this.bestVoice = this.voices.find(voice => 
          voice.name.includes('Natural') || 
          voice.name.includes('Neural') ||
          voice.name.includes('Samantha') ||
          voice.name.includes('Google US English Female') ||
          voice.name.includes('Alex')
        ) || this.voices.find(voice => voice.lang.startsWith('en')) || this.voices[0];
      };
      
      speechSynthesis.onvoiceschanged = loadVoices;
      loadVoices();
    }
  }

  async callBackendAI(userMessage) {
    try {
      // Convert conversation history to the format the backend expects
      const historyFormatted = this.conversationHistory.slice(-10).map(msg => ({
        role: msg.sender === 'user' ? 'user' : 'assistant',
        content: msg.text
      }));

      const response = await fetch(this.apiEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: userMessage,
          history: historyFormatted
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      return {
        text: data.response || data.error || "I'm here to help you think through this.",
        service: data.service || 'unknown'
      };

    } catch (error) {
      console.error('Backend AI call failed:', error);
      
      // Fallback to local response if backend fails
      return {
        text: this.getLocalFallback(userMessage),
        service: 'local_fallback'
      };
    }
  }

  getLocalFallback(userMessage) {
    const lower = userMessage.toLowerCase();
    
    const purchaseWords = ['buy', 'buying', 'purchase', 'order', 'sale', 'discount', 'deal', 'shopping'];
    const isPurchase = purchaseWords.some(word => lower.includes(word));
    
    if (isPurchase) {
      const responses = [
        "I hear you thinking about this purchase. What's drawing you to it right now?",
        "Let's pause together. Do you actually need this, or is it more of a want?",
        "Good question to think about - where would you put this once you get it home?",
        "How do you think you'll feel about this purchase tomorrow morning?"
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }
    
    if (lower.includes('hello') || lower.includes('hi')) {
      return "Hey! Nice to hear your voice. What's on your mind today?";
    }
    
    const responses = [
      "I'm listening. Tell me more about that.",
      "That sounds important to you. What's behind that feeling?",
      "I hear you. How are you processing that right now?",
      "Thanks for sharing that with me. What feels most important about this?"
    ];
    
    return responses[Math.floor(Math.random() * responses.length)];
  }

  addMessage(sender, text, service = null) {
    const chatContainer = document.getElementById('chatContainer');
    const messageEl = document.createElement('div');
    messageEl.className = `message ${sender}-message`;
    messageEl.textContent = text;
    
    // Add AI service indicator for AI messages
    if (sender === 'ai' && service) {
      const indicator = document.createElement('div');
      indicator.className = 'ai-indicator';
      indicator.textContent = `powered by ${service}`;
      messageEl.appendChild(indicator);
    }
    
    chatContainer.appendChild(messageEl);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    // Save to history
    this.conversationHistory.push({ sender, text, timestamp: Date.now() });
    
    // Keep last 50 messages for context
    if (this.conversationHistory.length > 50) {
      this.conversationHistory = this.conversationHistory.slice(-40);
    }
    
    localStorage.setItem('ai_conversation', JSON.stringify(this.conversationHistory));
  }

  restoreConversation() {
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML = '';
    
    this.conversationHistory.forEach(msg => {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${msg.sender}-message`;
      messageEl.textContent = msg.text;
      chatContainer.appendChild(messageEl);
    });
    
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  speak(text) {
    if (!('speechSynthesis' in window)) return;
    
    speechSynthesis.cancel();
    this.isSpeaking = true;
    
    const utterance = new SpeechSynthesisUtterance(text);
    if (this.bestVoice) {
      utterance.voice = this.bestVoice;
      utterance.lang = this.bestVoice.lang;
    }
    
    utterance.rate = 0.9;
    utterance.pitch = 1.1;
    utterance.volume = 0.8;
    
    utterance.onstart = () => {
      this.updateStatus('üó£Ô∏è Speaking...', 'speaking');
    };
    
    utterance.onend = () => {
      this.isSpeaking = false;
      if (this.isListening) {
        this.updateStatus('üé§ Listening...', 'listening');
      } else {
        this.updateStatus('Ready to listen and help you pause before impulse purchases');
      }
    };
    
    speechSynthesis.speak(utterance);
  }

  startListening() {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      alert('Voice recognition not supported in this browser. Try Chrome or Edge.');
      return;
    }

    if (this.isListening) return;

    this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    this.recognition.continuous = true;
    this.recognition.interimResults = true;
    this.recognition.lang = 'en-US';

    this.recognition.onstart = () => {
      this.isListening = true;
      this.updateMicButton();
      this.updateStatus('üé§ Listening...', 'listening');
    };

    this.recognition.onsoundstart = () => {
      // Stop speaking if user starts talking
      if (this.isSpeaking) {
        speechSynthesis.cancel();
        this.isSpeaking = false;
      }
    };

    this.recognition.onresult = (event) => {
      let finalTranscript = '';
      
      for (let i = event.resultIndex; i < event.results.length; i++) {
        if (event.results[i].isFinal) {
          finalTranscript += event.results[i][0].transcript;
        }
      }

      if (finalTranscript.trim()) {
        this.handleUserInput(finalTranscript.trim());
      }
    };

    this.recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      this.updateStatus('‚ö†Ô∏è Voice error. Click to try again.');
      this.isListening = false;
      this.updateMicButton();
    };

    this.recognition.onend = () => {
      this.isListening = false;
      this.updateMicButton();
      if (!this.isSpeaking) {
        this.updateStatus('Click microphone to continue talking');
      }
    };

    this.recognition.start();
  }

  async handleUserInput(userText) {
    this.addMessage('user', userText);
    this.updateStatus('üß† Thinking with AI...', 'thinking');
    
    // Get real AI response from backend
    const aiResult = await this.callBackendAI(userText);
    this.addMessage('ai', aiResult.text, aiResult.service);
    this.speak(aiResult.text);
  }

  stopListening() {
    if (this.recognition) {
      this.recognition.stop();
    }
    this.isListening = false;
    this.updateMicButton();
  }

  toggleMicrophone() {
    if (this.isListening) {
      this.stopListening();
    } else {
      this.startListening();
    }
  }

  updateMicButton() {
    const micBtn = document.getElementById('micBtn');
    const micIcon = document.getElementById('micIcon');
    const micText = document.getElementById('micText');
    
    if (this.isListening) {
      micBtn.classList.add('listening');
      micIcon.textContent = 'üî¥';
      micText.textContent = 'Stop Listening';
    } else {
      micBtn.classList.remove('listening');
      micIcon.textContent = 'üé§';
      micText.textContent = 'Start Listening';
    }
  }

  updateStatus(text, className = '') {
    const statusEl = document.getElementById('status');
    statusEl.textContent = text;
    statusEl.className = `status ${className}`;
  }

  clearChat() {
    document.getElementById('chatContainer').innerHTML = '';
    this.conversationHistory = [];
    localStorage.removeItem('ai_conversation');
    this.updateStatus('Conversation cleared. Ready for a fresh start!');
  }
}

// Initialize the app
const aiCoach = new AIVoiceCoach();

// Global functions for HTML onclick handlers
function toggleMicrophone() {
  aiCoach.toggleMicrophone();
}

function clearChat() {
  aiCoach.clearChat();
}

</script>
</body>
</html>
